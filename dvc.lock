schema: '2.0'
stages:
  download_images:
    cmd: python src/stages/download_images.py
    outs:
    - path: data/pet_images
      md5: bf51677a64428a5dfa8360e2b290036b.dir
      size: 113476945
      nfiles: 254
    - path: data/text_info/classes.csv
      md5: d1e5e6d57d350c572973af34a043f36c
      size: 8171
  split_data:
    cmd: python src/stages/split_data.py
    deps:
    - path: data/text_info/classes.csv
      md5: d1e5e6d57d350c572973af34a043f36c
      size: 8171
    params:
      params.yaml:
        data:
          local_images_folder: data/pet_images
          classes_text_file: data/text_info/classes.csv
          train_fracture: 0.7
          val_fracture: 0.2
          test_fracture: 0.1
          train_classes_file: data/text_info/train.csv
          val_classes_file: data/text_info/val.csv
          test_classes_file: data/text_info/test.csv
          train_h5_file: data/datasets/train.hdf5
          val_h5_file: data/datasets/val.hdf5
          test_h5_file: data/datasets/test.hdf5
          feature_extractor: microsoft/resnet-18
    outs:
    - path: data/text_info/test.csv
      md5: 44bc50792a2bf13a31c297cf4a6a0880
      size: 805
    - path: data/text_info/train.csv
      md5: 4406d53e6e1f78154dc8d9d42b3015c4
      size: 5779
    - path: data/text_info/val.csv
      md5: 50e9f439493f4cfd5bd9b33c150cc500
      size: 1611
  convert_images_to_h5:
    cmd: python src/stages/convert_images_to_hdf5.py
    deps:
    - path: data/pet_images
      md5: bf51677a64428a5dfa8360e2b290036b.dir
      size: 113476945
      nfiles: 254
    - path: data/text_info/test.csv
      md5: 44bc50792a2bf13a31c297cf4a6a0880
      size: 805
    - path: data/text_info/train.csv
      md5: 4406d53e6e1f78154dc8d9d42b3015c4
      size: 5779
    - path: data/text_info/val.csv
      md5: 50e9f439493f4cfd5bd9b33c150cc500
      size: 1611
    outs:
    - path: data/datasets/test.hdf5
      md5: 21f13338222f06bfcfb529f4569c3f2e
      size: 3629056
    - path: data/datasets/train.hdf5
      md5: 5982aa4cd1013e136eb1bcb0e4e350c7
      size: 27329792
    - path: data/datasets/val.hdf5
      md5: 5c4f89008d4159dc0c2454d420db06f9
      size: 7400448
  train_model:
    cmd: python src/stages/train_model.py
    deps:
    - path: data/datasets/test.hdf5
      md5: 21f13338222f06bfcfb529f4569c3f2e
      size: 3629056
    - path: data/datasets/train.hdf5
      md5: 5982aa4cd1013e136eb1bcb0e4e350c7
      size: 27329792
    - path: data/datasets/val.hdf5
      md5: 5c4f89008d4159dc0c2454d420db06f9
      size: 7400448
    - path: src/stages/train_model.py
      md5: 2dd3b626e60cff75a8f74ce851af7a57
      size: 3320
    params:
      params.yaml:
        augmentations:
          image_size: 224
          rotate_abs_angle: 25
          noise_lower_bound: 10
          noise_upper_bound: 30
          dropout_p: 0.01
          salt_and_pepper_p: 0.02
          blur_lower_kernel_bound: 1
          blur_upper_kernel_bound: 5
          jpeg_compression_bounds:
          - 50
          - 80
          motion_blur_bounds:
          - 3
          - 7
          gaussian_blur_bounds:
          - 0
          - 3
          color_multiplier:
          - 0.7
          - 1.5
          contrast_bounds:
          - 0.7
          - 1.4
          clahe_clip_limit:
          - 0.1
          - 4
          rotate_probability: 0.5
          arithmetic_probability: 0.5
          blur_probability: 0.5
          color_probability: 0.5
          contrast_probability: 0.5
        model:
          output_vector_size: 64
          triplet_loss_alpha: 1.0
          pretrained_model_name: microsoft/resnet-18
        trainer:
          eval_steps: 30
          train_batch_size: 8
          val_batch_size: 8
          epochs: 100
          learning_rate: 0.001
          weight_decay: 0.0015
          save_steps: 400
          fp16: true
          gradient_accumulation_steps: 1
          eval_accumulation_steps: 1
          trainer_checkpoint: ''
          output_folder: output
          loss_function: mse
          experiment_name: resnet_18_baseline
          compute_test_metrics: false
          tensorboard_log: output/tensorboard/latest
    outs:
    - path: output/model
      md5: 2937b169050d7057bc3bc2f3602a537c.dir
      size: 44929020
      nfiles: 2
    - path: output/tensorboard/latest
      md5: f4b73ba4205cea6ca32b06e3d96683ba.dir
      size: 79089
      nfiles: 2
    - path: output/val_metrics.json
      md5: 4264a9bb7002113762104c58b4be6fc0
      size: 325
  upload_files:
    cmd: python src/stages/upload_files.py
    deps:
    - path: output/model
      md5: 2937b169050d7057bc3bc2f3602a537c.dir
      size: 44929020
      nfiles: 2
    - path: output/tensorboard/latest
      md5: f4b73ba4205cea6ca32b06e3d96683ba.dir
      size: 79089
      nfiles: 2
    params:
      params.yaml:
        cloud_storage:
          credentials: keys/google.json
          bucket_name: pet_project
          images_folder: pet_images
          project_name: nlp-masters-project
          output_folder: trainer_output
  visualize:
    cmd: python src/stages/visualize_predictions.py
    deps:
    - path: data/datasets/test.hdf5
      md5: 21f13338222f06bfcfb529f4569c3f2e
      size: 3629056
    - path: output/model
      md5: 2937b169050d7057bc3bc2f3602a537c.dir
      size: 44929020
      nfiles: 2
    outs:
    - path: data/test_visualization.png
      md5: 1d327682ac38db784c595d2fed7bb0a9
      size: 2396
